name: Build and test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install apt deps
      run: |
        sudo apt install -y libcurl4-openssl-dev
    - name: fetch-deps
      run: |
        mkdir -p _build && cd _build
        git clone --single-branch -b maint-15.0.2 https://github.com/apache/arrow.git
        cd arrow && git apply ../../vendor/arrow/fix_c-ares_url.patch && cd ..
        ./arrow/cpp/thirdparty/download_dependencies.sh ./arrow-thirdparty
        pip3 install --upgrade --break-system-packages marshmallow==3.13.0 desert==2020.11.18 pynessie flask
        wget https://github.com/projectnessie/nessie/releases/download/nessie-0.104.1/nessie-quarkus-0.104.1-runner.jar
    - name: run rest
      run: |
        bash tests/rest/setup/init_nessie.sh
        cat nessie.log
        python3 tests/rest/setup/upload_table.py
    - name: cmake
      run: |
        cd _build
        cmake -GNinja ../
    - name: make
      run: |
        cd _build
        ninja
    - name: test
      run: |
        cd _build/tests/
        ../iceberg/iceberg-cpp-test
        ../iceberg/common/fs/iceberg_common_fs_test
        ./iceberg_local_test

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: fetch-deps
      run: |
        mkdir -p _build && cd _build
        git clone --single-branch -b maint-15.0.2 https://github.com/apache/arrow.git
        cd arrow && git apply ../../vendor/arrow/fix_c-ares_url.patch && cd ..
        ./arrow/cpp/thirdparty/download_dependencies.sh ./arrow-thirdparty
        pip3 install --upgrade --break-system-packages marshmallow==3.13.0 desert==2020.11.18 pynessie flask
        wget https://github.com/projectnessie/nessie/releases/download/nessie-0.104.1/nessie-quarkus-0.104.1-runner.jar
    - name: run rest
      run: |
        bash tests/rest/setup/init_nessie.sh
        cat nessie.log
        python3 tests/rest/setup/upload_table.py
    - name: cmake
      run: |
        cd _build
        cmake -GNinja ../
    - name: make
      run: |
        cd _build
        ninja
    - name: test
      run: |
        cd _build/tests/
        ../iceberg/iceberg-cpp-test
        ../iceberg/common/fs/iceberg_common_fs_test
        ./iceberg_local_test
